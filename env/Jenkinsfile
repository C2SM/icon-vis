pipeline {
    environment {
       PATH = "$WORKSPACE/miniconda/bin:$PATH"
    }
    agent {
        label ('tsa||daint')
    }
    post {
        always{
            echo 'Cleaning up workspace'
            deleteDir()
        }
    }
    stages {
        stage('setup miniconda') {
            steps {
                sh 'wget -O ${WORKSPACE}/miniconda.sh https://repo.continuum.io/miniconda/Miniconda3-latest-Linux-x86_64.sh'
                sh 'bash miniconda.sh -b -p $WORKSPACE/miniconda'
                sh 'conda config --set always_yes yes --set changeps1 no'
                sh 'conda config --add channels conda-forge'
                sh 'conda env create --name psyplot_${label} --file env/environment.yml'
                sh 'conda activate psyplot_${label}'
                sh 'source env/setup-conda-env.sh'
                sh 'conda deactivate'
                sh 'rm miniconda.sh'
            }        
        }
        stage('test') {
            steps {
                sh '''#!/usr/bin/env bash
                source $WORKSPACE/miniconda/etc/profile.d/conda.sh
                conda activate psyplot_${label}
                python -m cfgrib selfcheck
                pytest testsuite/test*
                '''
            }
        }
    }
}
